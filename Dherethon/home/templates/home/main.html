<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>홈</title>
  <style>
    .challenge-card, .popular-post, .recommended-card {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .progress-bar {
      height: 12px;
      background: #e0e0e0;
      border-radius: 6px;
      margin: 5px 0;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: #5A3FFF;
    }
    .button {
      padding: 6px 12px;
      background: #5A3FFF;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
    }
  </style>
</head>
<body>
            <!-- 좌측 사이드바 -->
        <div style="width:200px; padding:10px;">
            <p><strong>{{ request.user.nickname }}</strong></p>
            <ul>
                <p><a href="{% url 'home:main' %}">홈</a></p>
                <p><a href="{% url 'challenges:my_challenges' %}">나의 도전</a></p>
                <p><a href="{% url 'community:post_list' %}">커뮤니티</a></p>
                <p><a href="{% url 'home:badge_list' %}">뱃지</a></p>
            </ul>
            <p><a href="{% url 'api:logout' %}">Log out</a></p>
        </div>

<h2>👋 {{ request.user.nickname }} 님의 Challenges</h2>

<div id="my-challenges-box">
{% for challenge in my_challenges %}
  <div class="challenge-card">
    <h3>{{ challenge.title }}</h3>
    <div class="progress-bar">
      <div class="progress-fill" style="width: {{ challenge.progress }}%;"></div>
    </div>
    <p>진행률: {{ challenge.progress }}%</p>
    {% if challenge.next_goal %}
      <p><strong>다음 세부 목표:</strong> {{ challenge.next_goal.content }}</p>
      <a href="{% url 'challenges:create_goal' challenge.id %}" class="button">인증하러 가기 →</a>
    {% endif %}
  </div>
{% empty %}
  <p>진행 중인 도전이 없습니다.</p>
{% endfor %}
</div>

<hr>

<h2>🔥 인기 POST</h2>
{% for post in popular_posts %}
<div class="popular-post">
  <p>{{ post.content|truncatechars:50 }}</p>
  <p>❤️ 좋아요 {{ post.like_count }}</p>
  <a href="{% url 'community:post_detail' post.id %}">자세히 보기</a>
</div>
{% empty %}
<p>아직 게시글이 없습니다.</p>
{% endfor %}

<hr>

<div class="recommended-box">
 <h3>💡 다른 유저의 도전 추천</h3>

{% if recommended_challenges %}
    {% for item in recommended_challenges %}
        <div class="recommended-challenge-box">
            <h4>{{ item.challenge.user.nickname }}님의 Challenge</h4>
            <p><strong>{{ item.challenge.title }}</strong></p>
            <ul>
                {% for goal in item.goals %}
                    <li>{{ goal.content }}</li>
                {% endfor %}
            </ul>

            <!-- ✅ 여기에 이 코드 추가 -->
            <form method="post" action="{% url 'challenges:copy_challenge' item.challenge.id %}">
            {% csrf_token %}
            <button type="submit" class="button">도전 추가하기 ➕</button>
            </form>
        </div>
    {% endfor %}
{% else %}
    <p>추천할 도전이 아직 없습니다.</p>
{% endif %}
</div>


<script>
function refreshRecommendation() {
    fetch("{% url 'home:refresh_recommendation' %}")
        .then(res => res.json())
        .then(data => {
            document.getElementById("recommendation-card").innerHTML = data.html;
        });
}
</script>
</div>
<script>
function copyChallenge(challengeId) {
    fetch(`/copy-challenge/${challengeId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert("도전이 내 도전에 추가되었습니다!");
            // 새 도전 HTML을 my_challenges 영역에 삽입
            document.getElementById("my-challenges-box").insertAdjacentHTML("beforeend", data.new_challenge_html);
        } else {
            alert("추가에 실패했습니다.");
        }
    });
}
</script>

</body>
</html>
