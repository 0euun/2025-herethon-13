<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
{% load static %}
<h2>📝 인증 글 게시하기</h2>

<form method="post" enctype="multipart/form-data">
  {% csrf_token %}

  <p><strong>도전 선택:</strong>
    <select id="challenge-select">
      <option value="">도전을 선택하세요</option>
      {% for challenge in challenges %}
        <option value="{{ challenge.id }}">{{ challenge.title }}</option>
      {% endfor %}
    </select>
  </p>

  <p><strong>세부 목표 선택:</strong>
    <select name="goal" id="goal-select">
      <option value="">먼저 도전을 선택하세요</option>
    </select>
  </p>

  <div id="preview-container" style="display:none; margin-top: 20px;">
    <h4>미리보기</h4>
    <p><strong>내용:</strong> <span id="preview-content"></span></p>
    <p><strong>이미지:</strong><br><img id="preview-image" src="" alt="인증 이미지" width="200" style="display:none;"></p>
  </div>

  <button type="submit">게시하기</button>
</form>

<script>
  const challengeSelect = document.getElementById('challenge-select');
  const goalSelect = document.getElementById('goal-select');
  const previewContainer = document.getElementById('preview-container');
  const previewContent = document.getElementById('preview-content');
  const previewImage = document.getElementById('preview-image');

  challengeSelect.addEventListener('change', function () {
    const challengeId = this.value;
    fetch(`/community/load-goals/?challenge_id=${challengeId}`)
      .then(response => response.json())
      .then(data => {
        goalSelect.innerHTML = '<option value="">세부 목표를 선택하세요</option>';
        data.forEach(goal => {
          const option = document.createElement('option');
          option.value = goal.id;
          option.textContent = goal.content;
          option.dataset.content = goal.content;
          option.dataset.image = goal.image_url;
          goalSelect.appendChild(option);
        });
      });
  });

  goalSelect.addEventListener('change', function () {
    const selectedOption = this.options[this.selectedIndex];
    const content = selectedOption.dataset.content;
    const imageUrl = selectedOption.dataset.image;

    previewContent.textContent = content || '';

    if (imageUrl) {
      previewImage.src = imageUrl;
      previewImage.style.display = 'block';
    } else {
      previewImage.style.display = 'none';
    }

    previewContainer.style.display = 'block';
  });
</script>

</body>
</html>
